$(document).ready(function($) {
    
    var divs = [];
    //// Apply Chosen plugin functionality ////
    $("select#newObjectScheme").chosen();
    $("select#newObjectFields").chosen();
	
    $("select#objectsPerPage").chosen({
		disable_search: true
	});

    $("select#newObjectScheme, select#newObjectFields, select#searchObjects, select#objectsPerPage").removeAttr('disabled');


   /* $(".kora-objs").change(function(){
        var total = $('div.kora-objs div.kora-obj').length;
        alert(total);
    });

    $("#objectsPerPage").change(function(){
       //alert("1111"); 
    });*/
	
	$('<a href="#"  id="kora-upload" class="button">Add New Kora Object</a>').insertAfter('.wp-media-buttons');   
	
   	$('#kora-upload').click(function(){
   		tb_show('Add New Kora Object',plugin.url+'/kora_upload.php?pid='+plugin.pid+
   		'&sid='+plugin.sid+'&token='+plugin.token+'&user='+plugin.user+'&pass='+plugin.pass+'&restful='+plugin.restful+'&url='+plugin.url+
   		'&height=200&width=400&TB_iframe=true');
 		
 		return false;
   	});
	

	$('<a href="#"  id="kora-gallery" class="button">Add Kora Gallery</a>').insertAfter('#kora-upload');
	
	$('#kora-gallery').click(function(){
         tb_show('Add Kora Gallery',plugin.url+'/postgallery.php?pid='+plugin.pid+
         '&sid='+plugin.sid+'&token='+plugin.token+'&user='+plugin.user+'&pass='+plugin.pass+'&restful='+plugin.restful+'&url='+plugin.url+
         '&height=200&width=400&TB_iframe=true');
      
      return false;
    });
	  

    $('<a href="#"  id="kora-library" class="button">Add Existing Kora Object</a>').insertAfter('#kora-upload');

    $("#kora-library").click(function(){
         tb_show('Add Existing Kora Object',plugin.url+'/postlibrary.php?pid='+plugin.pid+
         '&sid='+plugin.sid+'&token='+plugin.token+'&user='+plugin.user+'&pass='+plugin.pass+'&restful='+plugin.restful+'&url='+plugin.url+
         '&height=200&width=400&TB_iframe=true');
    });
	  
	
	//// Similar to deleteKoraObjs() on Library page ////

	var selectedCount = 0;

    // Function to update 'Add Objects' button
	var addKoraObjs = function() {
		if (selectedCount == 0) {
			$('#add-kora-objs > input').val( 'Add Object(s) to Library' );
			$('#add-kora-objs').removeClass('slide-remove-objs');
		}
		
		else {
			$('#add-kora-objs > input').val( selectedCount + ' selected // add object(s) to library' );
			$('#add-kora-objs').addClass('slide-remove-objs');
		}
	};

    // Object Fields Click Functionality
	$('.kora-obj-fields').click( function(event) {
		// Stops click from registering twice
		event.stopImmediatePropagation();

        // Get associated Kora object
        var koraObj = $(this).parent().parent();
       
        koraObj.toggleClass('kora-obj-active');
		var objKID = koraObj.attr("id");
        // get control fileds name for each object
        var controldiv = [];
        controldiv.push(objKID);
        $(this).find('li').each(function(){
            var key = $(this).find('span');
            controldiv.push(key.text());
            //alert(key.text());
        });
        
		if( koraObj.hasClass('kora-obj-active') ) {
			selectedCount++;
            divs.push(controldiv);
            //divs.push(objKID);
          // alert(controldiv);
		}
		
		else {
			selectedCount--;
            //alert(koraObj.attr("alt"));
            for (var i =0; i < divs.length; i++){
		        if (divs[i][0] === objKID) {
		            divs.splice(i,1);
					break;
		        }
		    }
		}
		
		addKoraObjs();
	});


	//// "Select All" Button Functionality ////
	$('button#selectAll').click( function(event) {
		event.preventDefault();
		$('.kora-obj').addClass('kora-obj-active');

		// Update 'selectedCount' and 'Add Objects' button
		selectedCount = $('.kora-obj-active').length;
        addKoraObjs();
	});





    //// Functionality for "Edit Details" Button ////
    var editObjectModal = $('#editObjectModal.remodal');

    // Add class to modal, for styling purposes, if open
    if( editObjectModal.remodal().getState() == 'opened' ||
        editObjectModal.remodal().getState() == 'opening' ) {
        editObjectModal.parent().addClass( 'largeModal' );
        
    }

    // Open Modal
    $('div.kora-obj-left input[type=button]').click( function() {
        var kid_open  = $(this).attr('id');
        var schemeID = $(this).attr('alt');
        var koraobj = $(this).parent().parent();
       // alert(koraobj.attr('id'));
        var image_control = $("#image_control").text();
        var video_control = $("#video_control").text();
        var audio_control = $("#audio_control").text();
        var control_displayed = [];
        koraobj.find('li').each(function(){
            var key = $(this).find('span');
            control_displayed.push(key.text());
           // alert(key.text());
        });
       // alert(control_displayed);
       // alert(image_control);
        $.ajax({
                  type: "GET",
                  async: false,
                  url: url_plugin  + "ajaxKORAobject_details.php",
                  data: {"kid" : kid_open, "schemeid": schemeID,  "image_control": image_control,"video_control": video_control,"audio_control": audio_control, "control_displayed": control_displayed },
                  success: function(data){	
                    $('.object_details').html(data);  
                       
                  }
        });  
        editObjectModal.remodal().open();
        
    });


    //// "Edit Details" Modal /////////////////////////////////////////////////
    //// Back Arrow Functionality ////
    $('#editObjectModal img#backArrow').click( function() {
        editObjectModal.remodal().close();
    });

	//// Checkbox Functionality ////
	$('#editObjectModal input[type=checkbox]').click( function(event) {
        // Stops click from registering twice
        event.stopImmediatePropagation();

		var checkboxId = $(this).attr('id');
        var checkboxLabel = $('#editObjectModal label[for=' + checkboxId + ']');
        var checkboxPar = $('#editObjectModal p#' + checkboxId);

        // Toggle 'active' classes on associated label and paragraph
        checkboxLabel.toggleClass( 'activeLabel' );
        checkboxPar.toggleClass( 'activeParagraph' );
	});

    //// 'Update Object Details' Button Functionality ////
	$('#editObjectModal input[type=submit]').click( function() {
		editObjectModal.remodal().close();
	});
    
   $('#add-kora-objs').click(function() {
       
		//alert(divs[1]);
      // var schemeid = document.getElementById("newObjectScheme").value;
		//If no objects are checked
		//if(divs.length == 0){
		//	window.alert("No Objects Selected!");
		//} else {
             var image_control = $("#image_control").text();
             var video_control = $("#video_control").text();
             var audio_control = $("#audio_control").text();
                // alert(image_control);
            //When objects have been checked
            for (var i =0; i < divs.length; i++){
                var chk = divs[i][0];
                var controlfileds = divs[i];
                $.ajax({
                    type: "GET",
                    async: false,
                    url: url_plugin+"ajax/insert_library.php",
                    data: {"chk": chk, "schemeid" : schemeid, "image_control": image_control,"video_control": video_control,"audio_control": audio_control,"controlfileds" : controlfileds},
                   
                    success: function(data){
                       // alert(image_control);
                       // alert(video_control);
                       // alert(controlfileds);
                        //alert(schemeid);      
                    
                       // parent.location.reload();
                        if(data=='false'){
                                alert("Object is already in the library");
                                parent.location.reload();

                        } else if (data == false) {
                            alert("Object is already in the library");
                            parent.location.reload();
                        }
                        else{
                               
                              // alert(data);
                             //   alert("Object has been added in the library");
                                
                               //  alert(data);
                                //var obj = "<div class=\"lib_obj\"><span class='close_lib'>&times;</span><div class='lib_image'><a class = 'popupImage' href = '+data.url+'><img src="+data.url+" alt="+data.KID+"></a></div><div class='lib_title'>"+data.title+"</div></div>";
                                //$("#wpbody-content").append(obj);
                             //   parent.location.reload();
                              window.location = libraryUrl;
                        }
                          //  $('.koraobj_container').hide();
				
                    }
                });  
            }
      //  }

	});
	
});
